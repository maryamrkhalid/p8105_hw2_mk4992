P8105 HW2 – mk4992
================
Maryam Khalid
2025-10-01

- [Problem 1: FiveThirtyEight US Politics
  Dataset](#problem-1-fivethirtyeight-us-politics-dataset)
- [Problem 2: Mr. Trash Wheel
  Dataset](#problem-2-mr-trash-wheel-dataset)
- [Problem 3: Zillow Observed Rent Index (ZORI) in NYC (Jan
  2015-Aug 2024)
  Dataset](#problem-3-zillow-observed-rent-index-zori-in-nyc-jan-2015-aug-2024-dataset)

## Problem 1: FiveThirtyEight US Politics Dataset

Step 1: clean the data in pols-month.csv

``` r
pols <- read_csv("data/pols-month.csv") |>
  clean_names() |> 
  separate(mon, into = c("year","month","day"), sep = "-", convert = TRUE) |> 
  mutate(
    month = month.name[month] |> tolower(),
    president = case_when(
      prez_gop == 1 ~ "gop",
      prez_dem == 1 ~ "dem",
      TRUE ~ NA_character_
    )
  ) |> 
  select(year, month, president, everything(), -prez_gop, -prez_dem, -day)

# View the cleaned dataset
pols |> slice_head(n = 10)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["int"],"align":["right"]},{"label":["month"],"name":[2],"type":["chr"],"align":["left"]},{"label":["president"],"name":[3],"type":["chr"],"align":["left"]},{"label":["gov_gop"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["sen_gop"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["rep_gop"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["gov_dem"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["sen_dem"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["rep_dem"],"name":[9],"type":["dbl"],"align":["right"]}],"data":[{"1":"1947","2":"january","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"february","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"march","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"april","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"may","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"june","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"july","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"august","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"september","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"},{"1":"1947","2":"october","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

Step 2: clean the data in snp.csv

``` r
snp <- read_csv("data/snp.csv") |>
  clean_names() |> 
  separate(date, into = c("month","day","year"), sep = "/", convert = TRUE) |> 
  mutate(
    year = if_else(year <50, 2000 + year, 1900 + year), #modifies 2-digit years into 4-digits
    month = month.name[month] |> tolower(),
  ) |>
  arrange(year, match(month, tolower(month.name))) |>
  select(year, month, close)

# View the cleaned dataset
snp |> slice_head(n = 10)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[2],"type":["chr"],"align":["left"]},{"label":["close"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"1950","2":"january","3":"17.05"},{"1":"1950","2":"february","3":"17.22"},{"1":"1950","2":"march","3":"17.29"},{"1":"1950","2":"april","3":"17.96"},{"1":"1950","2":"may","3":"18.78"},{"1":"1950","2":"june","3":"17.69"},{"1":"1950","2":"july","3":"17.84"},{"1":"1950","2":"august","3":"18.42"},{"1":"1950","2":"september","3":"19.45"},{"1":"1950","2":"october","3":"19.53"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

Step 3: Clean the data in unemployment.csv

``` r
unemp <- read_csv("data/unemployment.csv") |>
  clean_names() |>
  pivot_longer(
    cols = -year,
    names_to  = "month",
    values_to = "unemployment_rate"
  ) |>
  mutate(
    # map jan→january, feb→february, etc.
    month = case_match(
      month,
      "jan" ~ "january",   "feb" ~ "february", "mar" ~ "march",
      "apr" ~ "april",     "may" ~ "may",      "jun" ~ "june",
      "jul" ~ "july",      "aug" ~ "august",   "sep" ~ "september",
      "oct" ~ "october",   "nov" ~ "november", "dec" ~ "december"
    ),
    # ensure numeric (percent as a number, not character)
    unemployment_rate = as.numeric(unemployment_rate)
  ) |>
  arrange(year, match(month, tolower(month.name)))

# quick peek
unemp |> slice_head(n = 12)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[2],"type":["chr"],"align":["left"]},{"label":["unemployment_rate"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"1948","2":"january","3":"3.4"},{"1":"1948","2":"february","3":"3.8"},{"1":"1948","2":"march","3":"4.0"},{"1":"1948","2":"april","3":"3.9"},{"1":"1948","2":"may","3":"3.5"},{"1":"1948","2":"june","3":"3.6"},{"1":"1948","2":"july","3":"3.6"},{"1":"1948","2":"august","3":"3.9"},{"1":"1948","2":"september","3":"3.8"},{"1":"1948","2":"october","3":"3.7"},{"1":"1948","2":"november","3":"3.8"},{"1":"1948","2":"december","3":"4.0"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

Step 4: merge snp into pols, and then merge unemployment into the result

``` r
# 1) merge S&P into pols
pols_snp <- left_join(pols, snp, by = c("year", "month"))

# 2) merge unemployment into the result
pols_snp_unemp <- left_join(pols_snp, unemp, by = c("year", "month"))

# quick sanity checks
dim(pols_snp_unemp)          # rows, cols
```

    ## [1] 822  11

``` r
sum(is.na(pols_snp_unemp$close))            
```

    ## [1] 36

``` r
sum(is.na(pols_snp_unemp$unemployment_rate))
```

    ## [1] 12

``` r
pols_snp_unemp |> slice_head(n = 6)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[2],"type":["chr"],"align":["left"]},{"label":["president"],"name":[3],"type":["chr"],"align":["left"]},{"label":["gov_gop"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["sen_gop"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["rep_gop"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["gov_dem"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["sen_dem"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["rep_dem"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["close"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["unemployment_rate"],"name":[11],"type":["dbl"],"align":["right"]}],"data":[{"1":"1947","2":"january","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198","10":"NA","11":"NA"},{"1":"1947","2":"february","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198","10":"NA","11":"NA"},{"1":"1947","2":"march","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198","10":"NA","11":"NA"},{"1":"1947","2":"april","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198","10":"NA","11":"NA"},{"1":"1947","2":"may","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198","10":"NA","11":"NA"},{"1":"1947","2":"june","3":"dem","4":"23","5":"51","6":"253","7":"23","8":"45","9":"198","10":"NA","11":"NA"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

``` r
# dimensions + year ranges
p1_dim_pols  <- dim(pols)
p1_dim_snp   <- dim(snp)
p1_dim_unemp <- dim(unemp)
p1_dim_final <- dim(pols_snp_unemp)

p1_yrs_pols  <- range(pols$year, na.rm = TRUE)
p1_yrs_snp   <- range(snp$year,  na.rm = TRUE)
p1_yrs_unemp <- range(unemp$year, na.rm = TRUE)
p1_yrs_final <- range(pols_snp_unemp$year, na.rm = TRUE)

# quick NA counts you can reference if you want
p1_na_close  <- sum(is.na(pols_snp_unemp$close))
p1_na_unemp  <- sum(is.na(pols_snp_unemp$unemployment_rate))
```

The `pols-month` dataset has 822 rows and 9 columns spanning 1947–2015.
It gives of information about the \# of federal politicians who are
Democratic or Republican at any given time (# of governors, senators,
house representatives of each party & whether the president at the time
was GOP/Dem). The `snp` dataset has 787 rows and 3 columns (1950–2015).
It gives us observations related to the S&P stock market index, giving
us the date of the observation & the closing value of the S&P stock
index on that given date. The `unemp` dataset has 816 rows and 3 columns
(1948–2015). The first variable ‘Year’ contains the 4-digit year in its
column, and the other variables are the months Jan through Dec. The
values below the month columns indicate the percentage of unemployment
in that column’s month in that row’s year. After merging, the final
dataset has 822 rows and 11 columns over 1947–2015. Our final
‘pols_snp_unemp’ dataset allows us to track over time (by each
month-year combination): the closing S&P index value, the unemployment
rate, and the number of elected politicians of each party in office in
various federal positions. Thus, we can take a birds-eye view of the
economic and political state of the US at a given month-year in time.

## Problem 2: Mr. Trash Wheel Dataset

``` r
library(readxl)
tw_path <- file.path("data", "202509 Trash Wheel Collection Data.xlsx")
```

Step 1: Clean the datasets

``` r
library(dplyr)
library(janitor)
library(stringr)
library(readxl)

#Mr Trash Wheel
mr <- read_excel(tw_path, sheet = "Mr. Trash Wheel", skip = 1) |>
  clean_names() |>
  select(!contains("notes")) |>
  filter(!is.na(dumpster)) |>
  mutate(across(any_of("sports_balls"), ~ as.integer(round(.x)))) |>
  mutate(
    wheel = "Mr. Trash Wheel",
    year  = as.integer(year),
    month = str_to_title(as.character(month))
  )

mr |> slice_head(n = 5)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["dumpster"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[2],"type":["chr"],"align":["left"]},{"label":["year"],"name":[3],"type":["int"],"align":["right"]},{"label":["date"],"name":[4],"type":["dttm"],"align":["right"]},{"label":["weight_tons"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["volume_cubic_yards"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["plastic_bottles"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["polystyrene"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["cigarette_butts"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["glass_bottles"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["plastic_bags"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["wrappers"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["sports_balls"],"name":[13],"type":["int"],"align":["right"]},{"label":["homes_powered"],"name":[14],"type":["dbl"],"align":["right"]},{"label":["x15"],"name":[15],"type":["lgl"],"align":["right"]},{"label":["x16"],"name":[16],"type":["lgl"],"align":["right"]},{"label":["wheel"],"name":[17],"type":["chr"],"align":["left"]}],"data":[{"1":"1","2":"May","3":"2014","4":"2014-05-16","5":"4.31","6":"18","7":"1450","8":"1820","9":"126000","10":"72","11":"584","12":"1162","13":"7","14":"0","15":"NA","16":"NA","17":"Mr. Trash Wheel"},{"1":"2","2":"May","3":"2014","4":"2014-05-16","5":"2.74","6":"13","7":"1120","8":"1030","9":"91000","10":"42","11":"496","12":"874","13":"5","14":"0","15":"NA","16":"NA","17":"Mr. Trash Wheel"},{"1":"3","2":"May","3":"2014","4":"2014-05-16","5":"3.45","6":"15","7":"2450","8":"3100","9":"105000","10":"50","11":"1080","12":"2032","13":"6","14":"0","15":"NA","16":"NA","17":"Mr. Trash Wheel"},{"1":"4","2":"May","3":"2014","4":"2014-05-17","5":"3.10","6":"15","7":"2380","8":"2730","9":"100000","10":"52","11":"896","12":"1971","13":"6","14":"0","15":"NA","16":"NA","17":"Mr. Trash Wheel"},{"1":"5","2":"May","3":"2014","4":"2014-05-17","5":"4.06","6":"18","7":"980","8":"870","9":"120000","10":"72","11":"368","12":"753","13":"7","14":"0","15":"NA","16":"NA","17":"Mr. Trash Wheel"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

``` r
#Professor Trash Wheel
prof <- read_excel(tw_path, sheet = "Professor Trash Wheel", skip = 1) |>
  clean_names() |>
  select(!contains("notes")) |>
  filter(!is.na(dumpster)) |>
  mutate(
    across(any_of("sports_balls"), ~ as.integer(round(.x)))  # only if present
  ) |>
  mutate(
    wheel = "Professor Trash Wheel",
    year  = as.integer(year),
    month = str_to_title(as.character(month))
  )

#Gwynn Falls Trash Wheel
gwyn <- read_excel(tw_path, sheet = "Gwynns Falls Trash Wheel", skip = 1) |>
  clean_names() |>
  select(!contains("notes")) |>
  filter(!is.na(dumpster)) |>
  mutate(across(any_of("sports_balls"), ~ as.integer(round(.x)))) |>
  mutate(
    wheel = "Gwynnda",
    year  = as.integer(year),
    month = str_to_title(as.character(month))
  )

gwyn |> slice_head(n = 5)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["dumpster"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[2],"type":["chr"],"align":["left"]},{"label":["year"],"name":[3],"type":["int"],"align":["right"]},{"label":["date"],"name":[4],"type":["dttm"],"align":["right"]},{"label":["weight_tons"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["volume_cubic_yards"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["plastic_bottles"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["polystyrene"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["cigarette_butts"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["plastic_bags"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["wrappers"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["homes_powered"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["wheel"],"name":[13],"type":["chr"],"align":["left"]}],"data":[{"1":"1","2":"July","3":"2021","4":"2021-07-03","5":"0.93","6":"15","7":"1200","8":"360","9":"3400","10":"1800","11":"NA","12":"15.50000","13":"Gwynnda"},{"1":"2","2":"July","3":"2021","4":"2021-07-07","5":"2.26","6":"15","7":"2000","8":"240","9":"3900","10":"2200","11":"NA","12":"37.66667","13":"Gwynnda"},{"1":"3","2":"July","3":"2021","4":"2021-07-07","5":"1.62","6":"15","7":"1800","8":"270","9":"2900","10":"2400","11":"NA","12":"27.00000","13":"Gwynnda"},{"1":"4","2":"July","3":"2021","4":"2021-07-16","5":"1.76","6":"15","7":"1000","8":"180","9":"2100","10":"1800","11":"NA","12":"29.33333","13":"Gwynnda"},{"1":"5","2":"July","3":"2021","4":"2021-07-30","5":"1.53","6":"15","7":"2100","8":"240","9":"4000","10":"2700","11":"NA","12":"25.50000","13":"Gwynnda"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

Step 2: Combine the datasets altogether

``` r
trash <- bind_rows(mr, prof, gwyn) |>
  select(where(~ !all(is.na(.)))) |>
  select(
    wheel, dumpster, month, year, weight_tons, volume_cubic_yards,
    everything()
  ) |>
  arrange(wheel, year, match(month, month.name))

# sanity checks
trash |> count(wheel)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["wheel"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"Gwynnda","2":"349"},{"1":"Mr. Trash Wheel","2":"707"},{"1":"Professor Trash Wheel","2":"132"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

``` r
range(trash$year, na.rm = TRUE)
```

    ## [1] 2014 2025

``` r
trash |> slice_head(n = 5)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["wheel"],"name":[1],"type":["chr"],"align":["left"]},{"label":["dumpster"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[3],"type":["chr"],"align":["left"]},{"label":["year"],"name":[4],"type":["int"],"align":["right"]},{"label":["weight_tons"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["volume_cubic_yards"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["date"],"name":[7],"type":["dttm"],"align":["right"]},{"label":["plastic_bottles"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["polystyrene"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["cigarette_butts"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["glass_bottles"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["plastic_bags"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["wrappers"],"name":[13],"type":["dbl"],"align":["right"]},{"label":["sports_balls"],"name":[14],"type":["int"],"align":["right"]},{"label":["homes_powered"],"name":[15],"type":["dbl"],"align":["right"]}],"data":[{"1":"Gwynnda","2":"1","3":"July","4":"2021","5":"0.93","6":"15","7":"2021-07-03","8":"1200","9":"360","10":"3400","11":"NA","12":"1800","13":"NA","14":"NA","15":"15.50000"},{"1":"Gwynnda","2":"2","3":"July","4":"2021","5":"2.26","6":"15","7":"2021-07-07","8":"2000","9":"240","10":"3900","11":"NA","12":"2200","13":"NA","14":"NA","15":"37.66667"},{"1":"Gwynnda","2":"3","3":"July","4":"2021","5":"1.62","6":"15","7":"2021-07-07","8":"1800","9":"270","10":"2900","11":"NA","12":"2400","13":"NA","14":"NA","15":"27.00000"},{"1":"Gwynnda","2":"4","3":"July","4":"2021","5":"1.76","6":"15","7":"2021-07-16","8":"1000","9":"180","10":"2100","11":"NA","12":"1800","13":"NA","14":"NA","15":"29.33333"},{"1":"Gwynnda","2":"5","3":"July","4":"2021","5":"1.53","6":"15","7":"2021-07-30","8":"2100","9":"240","10":"4000","11":"NA","12":"2700","13":"NA","14":"NA","15":"25.50000"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

``` r
# (a) Total weight (tons) collected by Professor Trash Wheel
prof_weight_total_tons <- trash |>
  dplyr::filter(wheel == "Professor Trash Wheel") |>
  dplyr::summarise(total_tons = sum(weight_tons, na.rm = TRUE)) |>
  dplyr::pull(total_tons)

# (b) Total cigarette butts collected by Gwynnda in June 2022
gwynnda_cigs_june_2022 <- trash |>
  dplyr::filter(wheel == "Gwynnda", year == 2022, month == "June") |>
  dplyr::summarise(total_cigs = sum(cigarette_butts, na.rm = TRUE)) |>
  dplyr::pull(total_cigs)
```

``` r
p2_n            <- nrow(trash)
p2_n_wheels     <- dplyr::n_distinct(trash$wheel)
p2_year_range   <- range(trash$year, na.rm = TRUE)
p2_wheel_counts <- trash |> dplyr::count(wheel, name = "n_obs")
```

After cleaning and combining the three datasets of these different trash
wheel devices, the dataset has 1188 observations (one per dumpster). Key
variables include `month`, `year`, `weight_tons`, `volume_cubic_yards`,
and item counts such as `plastic_bottles`, `polystyrene`,
`cigarette_butts`, `glass_bottles`, `plastic_bags`, `wrappers`, and
`sports_balls`.

The combined dataset has 1188 observations across 3 wheels, spanning
2014–2025. By wheel: Gwynnda = 349; Mr. Trash Wheel = 707; Professor
Trash Wheel = 132.

Professor Trash Wheel collected a total of 282.3 tons of trash. Gwynnda
collected 18,120 cigarette butts in June 2022.

## Problem 3: Zillow Observed Rent Index (ZORI) in NYC (Jan 2015-Aug 2024) Dataset

``` r
library(tidyverse)
library(janitor)
library(lubridate)
library(readr)
library(dplyr)
library(stringr)

# ZIP code → county / neighborhood mapping
zip_raw <- read_csv("data/Zip Codes.csv", show_col_types = FALSE) |>
  clean_names()

# map NYC counties to their respective boroughs
county_to_borough <- function(x) {
  x_low <- stringr::str_to_lower(x)
  x_low <- stringr::str_remove(x_low, "\\s*county$")
  dplyr::case_when(
    x_low == "new york" ~ "Manhattan",
    x_low == "kings"    ~ "Brooklyn",
    x_low == "queens"   ~ "Queens",
    x_low == "bronx"    ~ "Bronx",
    x_low == "richmond" ~ "Staten Island",
    TRUE ~ NA_character_
  )
}

zips <- zip_raw |>
  mutate(
    zip = stringr::str_pad(as.character(zip_code), width = 5, pad = "0"),
    borough = county_to_borough(county)
  ) |>
  select(zip, neighborhood, borough, county, county_fips, state_fips)

zip_xwalk <- zips |>
  arrange(zip, neighborhood) |>
  group_by(zip) |>
  summarise(
    borough      = dplyr::first(stats::na.omit(borough),      default = NA_character_),
    neighborhood = dplyr::first(stats::na.omit(neighborhood), default = NA_character_),
    county       = dplyr::first(stats::na.omit(county),       default = NA_character_),
    .groups = "drop"
  )

names(zip_raw)
```

    ## [1] "county"       "state_fips"   "county_code"  "county_fips"  "zip_code"    
    ## [6] "file_date"    "neighborhood"

``` r
# Read Zillow wide file (keep original date column names so regex matches)
zori_wide <- read_csv("data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv", show_col_types = FALSE)

# Keep ZIP-level rows, make a 5-digit ZIP
zori_zip <- zori_wide |>
  filter(StateName == "NY", str_detect(tolower(RegionType), "zip")) |>
  mutate(zip = str_pad(as.character(RegionName), 5, pad = "0"))

#identify metadata (non-date) columns, treat everything else as date
meta_cols <- c("RegionID","SizeRank","RegionName","RegionType",
               "StateName","State","City","Metro","CountyName")

date_cols <- names(zori_zip)[grepl(
  "^(\\d{1,2}/\\d{1,2}/\\d{2,4}|\\d{4}-\\d{2}-\\d{2})$",
  names(zori_zip)
)]

#Pivot all date columns
zori_long <- zori_zip |>
  tidyr::pivot_longer(
    cols = all_of(date_cols),
    names_to  = "date",
    values_to = "zori"
  ) |>
  mutate(
    date = coalesce(lubridate::mdy(date), lubridate::ymd(date))
  ) |>
  arrange(zip, date) |>
  select(
    zip, date, zori,
    region_id = RegionID, size_rank = SizeRank, region_type = RegionType,
    state_name = StateName, state = State, city = City, metro = Metro,
    county_name = CountyName
  )

# Quick peek
zori_long |> slice_head(n = 6)
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["zip"],"name":[1],"type":["chr"],"align":["left"]},{"label":["date"],"name":[2],"type":["date"],"align":["right"]},{"label":["zori"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["region_id"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["size_rank"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["region_type"],"name":[6],"type":["chr"],"align":["left"]},{"label":["state_name"],"name":[7],"type":["chr"],"align":["left"]},{"label":["state"],"name":[8],"type":["chr"],"align":["left"]},{"label":["city"],"name":[9],"type":["chr"],"align":["left"]},{"label":["metro"],"name":[10],"type":["chr"],"align":["left"]},{"label":["county_name"],"name":[11],"type":["chr"],"align":["left"]}],"data":[{"1":"10001","2":"2015-01-31","3":"3855.089","4":"61615","5":"4444","6":"zip","7":"NY","8":"NY","9":"New York","10":"New York-Newark-Jersey City, NY-NJ-PA","11":"New York County"},{"1":"10001","2":"2015-02-28","3":"3892.376","4":"61615","5":"4444","6":"zip","7":"NY","8":"NY","9":"New York","10":"New York-Newark-Jersey City, NY-NJ-PA","11":"New York County"},{"1":"10001","2":"2015-03-31","3":"3898.212","4":"61615","5":"4444","6":"zip","7":"NY","8":"NY","9":"New York","10":"New York-Newark-Jersey City, NY-NJ-PA","11":"New York County"},{"1":"10001","2":"2015-04-30","3":"3969.644","4":"61615","5":"4444","6":"zip","7":"NY","8":"NY","9":"New York","10":"New York-Newark-Jersey City, NY-NJ-PA","11":"New York County"},{"1":"10001","2":"2015-05-31","3":"4033.221","4":"61615","5":"4444","6":"zip","7":"NY","8":"NY","9":"New York","10":"New York-Newark-Jersey City, NY-NJ-PA","11":"New York County"},{"1":"10001","2":"2015-06-30","3":"4070.808","4":"61615","5":"4444","6":"zip","7":"NY","8":"NY","9":"New York","10":"New York-Newark-Jersey City, NY-NJ-PA","11":"New York County"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

``` r
# 1) Join first
tmp <- zori_long |>
  left_join(zip_xwalk, by = "zip")

# 2) Ensure a 'county' column exists (inject NA if it doesn't)
if (!"county" %in% names(tmp)) tmp$county <- NA_character_

# 3) Coalesce to prefer crosswalk county, fallback to Zillow's county_name
final <- tmp |>
  mutate(
    county = dplyr::coalesce(county, county_name),
    year   = lubridate::year(date),
    month  = lubridate::month(date, label = TRUE, abbr = FALSE)
  ) |>
  select(
    zip, borough, neighborhood, county,
    date, year, month, zori,
    region_id, size_rank, region_type, city, metro, state_name, state
  ) |>
  arrange(zip, date)

# counts
n_obs_final   <- nrow(final)
n_zip_final   <- dplyr::n_distinct(final$zip)
n_neigh_final <- dplyr::n_distinct(final$neighborhood)


# zips present in crosswalk but missing in Zillow
zips_in_zori          <- zori_long |> dplyr::distinct(zip)
zips_only_crosswalk   <- dplyr::anti_join(zip_xwalk, zips_in_zori, by = "zip")


# Jan 2020 vs Jan 2021 drop table
jan2020 <- final |> dplyr::filter(date == as.Date("2020-01-31")) |> dplyr::select(zip, zori_2020 = zori)
jan2021 <- final |> dplyr::filter(date == as.Date("2021-01-31")) |> dplyr::select(zip, zori_2021 = zori)

drop_tbl <- jan2021 |>
  dplyr::inner_join(jan2020, by = "zip") |>
  dplyr::mutate(change_2020_to_2021 = zori_2021 - zori_2020) |>
  dplyr::left_join(dplyr::select(zip_xwalk, zip, borough, neighborhood), by = "zip") |>
  dplyr::arrange(change_2020_to_2021) |>
  dplyr::slice_head(n = 10) |>
  dplyr::select(zip, borough, neighborhood, zori_2020, zori_2021, change_2020_to_2021)

drop_tbl
```

<div data-pagedtable="false">

<script data-pagedtable-source type="application/json">
{"columns":[{"label":["zip"],"name":[1],"type":["chr"],"align":["left"]},{"label":["borough"],"name":[2],"type":["chr"],"align":["left"]},{"label":["neighborhood"],"name":[3],"type":["chr"],"align":["left"]},{"label":["zori_2020"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["zori_2021"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["change_2020_to_2021"],"name":[6],"type":["dbl"],"align":["right"]}],"data":[{"1":"10007","2":"Manhattan","3":"Lower Manhattan","4":"6334.211","5":"5421.614","6":"-912.5966"},{"1":"10069","2":"Manhattan","3":"NA","4":"4623.042","5":"3874.918","6":"-748.1245"},{"1":"10009","2":"Manhattan","3":"Lower East Side","4":"3406.442","5":"2692.187","6":"-714.2550"},{"1":"10016","2":"Manhattan","3":"Gramercy Park and Murray Hill","4":"3731.135","5":"3019.431","6":"-711.7045"},{"1":"10001","2":"Manhattan","3":"Chelsea and Clinton","4":"4108.098","5":"3397.648","6":"-710.4499"},{"1":"10002","2":"Manhattan","3":"Lower East Side","4":"3645.416","5":"2935.113","6":"-710.3028"},{"1":"10004","2":"Manhattan","3":"Lower Manhattan","4":"3149.658","5":"2443.697","6":"-705.9608"},{"1":"10038","2":"Manhattan","3":"Lower Manhattan","4":"3573.201","5":"2875.616","6":"-697.5853"},{"1":"10012","2":"Manhattan","3":"Greenwich Village and Soho","4":"3628.566","5":"2942.344","6":"-686.2218"},{"1":"10010","2":"Manhattan","3":"Gramercy Park and Murray Hill","4":"3697.284","5":"3012.353","6":"-684.9304"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>

</div>

``` r
knitr::kable(
  drop_tbl,
  digits = 1,
  caption = "Largest declines in ZORI from Jan 2020 to Jan 2021 (NYC ZIPs)"
)
```

| zip | borough | neighborhood | zori_2020 | zori_2021 | change_2020_to_2021 |
|:---|:---|:---|---:|---:|---:|
| 10007 | Manhattan | Lower Manhattan | 6334.2 | 5421.6 | -912.6 |
| 10069 | Manhattan | NA | 4623.0 | 3874.9 | -748.1 |
| 10009 | Manhattan | Lower East Side | 3406.4 | 2692.2 | -714.3 |
| 10016 | Manhattan | Gramercy Park and Murray Hill | 3731.1 | 3019.4 | -711.7 |
| 10001 | Manhattan | Chelsea and Clinton | 4108.1 | 3397.6 | -710.4 |
| 10002 | Manhattan | Lower East Side | 3645.4 | 2935.1 | -710.3 |
| 10004 | Manhattan | Lower Manhattan | 3149.7 | 2443.7 | -706.0 |
| 10038 | Manhattan | Lower Manhattan | 3573.2 | 2875.6 | -697.6 |
| 10012 | Manhattan | Greenwich Village and Soho | 3628.6 | 2942.3 | -686.2 |
| 10010 | Manhattan | Gramercy Park and Murray Hill | 3697.3 | 3012.4 | -684.9 |

Largest declines in ZORI from Jan 2020 to Jan 2021 (NYC ZIPs)

``` r
final_clean <- final |> filter(!is.na(zori))
```

The merged Zillow–ZIP dataset has 17284 observations (one row per
ZIP×month) from January 2015 all through August 2024. It includes 149
unique ZIP codes and 43 unique neighborhoods. The key variables are:
`zip`, `borough`, `neighborhood`, `date`/`year`/`month`, and `zori`
(Zillow Observed Rent Index), plus extra data (`region_id`, `size_rank`,
`city`, `metro`, `state`).

There are 171 ZIP codes that appear in the city ZIP crosswalk but have
no ZORI values. Examples are listed above. The likely reasons for this
situation includes: PO-box-only ZIPs, non-residential/commercial ZIPs,
zip-code boundary changes over time.

The table above lists the 10 ZIP codes with the largest ZORI declines
from January 2020 to January 2021 (with borough and neighborhood). These
areas tend to be pricier, denser neighborhoods that saw emigration and
rental concessions/decreased costs early in the pandemic.
